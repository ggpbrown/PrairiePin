<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PrairiePin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#085e46',
            secondary: '#8cc084',
            highlight: '#F1FDF4',
            grayish: '#91a2a8',
            soft: '#c1d7ae',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-100">
  <header class="bg-highlight p-4 shadow relative">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-primary">PrairiePin</h1>
        <p class="text-sm text-secondary -mt-1">Because the grid doesn't have street signs.</p>
      </div>
      <div id="nav-links" class="flex gap-4">
        <a href="/user-profile.html" class="text-sm text-blue-600 underline">My Profile</a>
        <button onclick="logout()" class="bg-red-600 text-white px-4 py-1 rounded hover:bg-red-700">Log Out</button>
      </div>
      
    </div>
  </header>

  <main class="max-w-4xl mx-auto mt-8 bg-white p-6 rounded-xl shadow">
    <div class="mb-6">
      <h2 id="greeting" class="text-xl font-semibold text-green-900 mb-4"></h2>
      <label for="lld" class="block text-sm font-medium text-gray-700">Enter Legal Land Description (LLD)</label>
      <input type="text" id="lld" name="lld" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="e.g. SW-24-38-20-W5" />
      <button onclick="convertLLD()" class="mt-3 bg-primary hover:bg-green-800 text-white px-4 py-2 rounded">Convert</button>
    </div>

    <div class="mb-6 hidden" id="resultBox">
      <label for="result" class="block text-sm font-medium text-gray-700">Result</label>
      <p class="text-sm mt-1"><strong>Latitude:</strong> <span id="latOutput"></span></p>
      <p class="text-sm"><strong>Longitude:</strong> <span id="lngOutput"></span></p>
      <p class="mt-1 text-sm text-blue-700 underline">
        <a href="#" target="_blank" id="mapLink">View on Google Maps</a>
      </p>
      <button onclick="copyCoordinates()" class="mt-3 bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded">Copy Coordinates</button>
    </div>

    <div id="successBox" class="hidden bg-green-100 text-green-800 px-4 py-2 rounded mb-4">Coordinates successfully retrieved!</div>
    <div id="errorBox" class="hidden bg-red-100 text-red-800 px-4 py-2 rounded mb-4">An error occurred during conversion.</div>

    <h3 class="text-lg font-semibold mb-2">Last 10 Lookups</h3>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-highlight text-left">
            <th class="px-3 py-2">Timestamp</th>
            <th class="px-3 py-2">LLD</th>
            <th class="px-3 py-2">Province</th>
            <th class="px-3 py-2">Latitude</th>
            <th class="px-3 py-2">Longitude</th>
          </tr>
        </thead>
        <tbody id="lookup-table-body"></tbody>
      </table>
    </div>
  </main>

  <script>
    function decodeJWT(token) {
      try {
        return JSON.parse(atob(token.split('.')[1]));
      } catch {
        return null;
      }
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    }

    const token = localStorage.getItem('token');
    const decoded = decodeJWT(token);
    if (!decoded) {
      window.location.href = '/login.html';
    } else {
      if (decoded?.firstName) {
        document.getElementById('greeting').textContent = `Welcome back, ${decoded.firstName}!`;
      }
      fetchLookups();
    }

    async function convertLLD() {
      const lld = document.getElementById('lld').value;
      const resultBox = document.getElementById('resultBox');
      const errorBox = document.getElementById('errorBox');
      const successBox = document.getElementById('successBox');

      resultBox.classList.add('hidden');
      errorBox.classList.add('hidden');
      successBox.classList.add('hidden');

      try {
        const res = await fetch('https://prairiepin-production.up.railway.app/convert?lld=' + encodeURIComponent(lld), {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.latitude && data.longitude) {
          document.getElementById('latOutput').textContent = data.latitude;
          document.getElementById('lngOutput').textContent = data.longitude;
          document.getElementById('mapLink').href = `https://maps.google.com/?q=${data.latitude},${data.longitude}`;
          resultBox.classList.remove('hidden');
          successBox.classList.remove('hidden');
        } else {
          throw new Error('Invalid coordinates');
        }
      } catch (err) {
        errorBox.classList.remove('hidden');
        console.error(err);
      }
    }

    function copyCoordinates() {
      const lat = document.getElementById('latOutput').textContent;
      const lng = document.getElementById('lngOutput').textContent;
      navigator.clipboard.writeText(`${lat}, ${lng}`);
    }

    async function fetchLookups() {
      const res = await fetch('https://prairiepin-production.up.railway.app/lookups', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      console.log("ðŸ‘€ Lookup Data:", data);  // â† Add this line

      const tbody = document.getElementById('lookup-table-body');
      tbody.innerHTML = '';
      const last10 = data.lookups?.slice(0, 10) || [];
      last10.forEach((lookup, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-white' : 'bg-highlight';
        row.innerHTML = `
          <td class="px-3 py-2">${new Date(lookup.timestamp).toLocaleString()}</td>
          <td class="px-3 py-2">${lookup.lld_entered}</td>
          <td class="px-3 py-2">${lookup.province || 'â€”'}</td>
          <td class="px-3 py-2">${lookup.latitude}</td>
          <td class="px-3 py-2">${lookup.longitude}</td>
        `;
        tbody.appendChild(row);
      });
    }

    const decoded = decodeJWT(token);

    if (decoded?.isAdmin) {
      const adminLink = document.createElement('a');
      adminLink.href = '/admin.html';
      adminLink.textContent = 'Admin Tools';
      adminLink.className = 'text-sm text-blue-600 underline ml-4';
      document.getElementById('nav-links').appendChild(adminLink);
    }
  </script>
  <script>
  const token = localStorage.getItem('token');
  if (token) {
    const decoded = JSON.parse(atob(token.split('.')[1]));

    // Show Admin Tools if admin
    if (decoded?.isAdmin) {
      const adminLink = document.createElement('a');
      adminLink.href = '/admin.html';
      adminLink.textContent = 'Admin Tools';
      adminLink.className = 'text-sm text-blue-600 underline ml-4';
      document.getElementById('navLinks').appendChild(adminLink);
    }

    // Personal greeting
    const greeting = document.getElementById('greeting');
    if (greeting && decoded.firstName) {
      greeting.textContent = `Welcome back, ${decoded.firstName}!`;
    }
  }
</script>
</body>
</html>