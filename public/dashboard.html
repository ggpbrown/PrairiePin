<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PrairiePin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100">
  <header class="bg-[#F1FDF4] p-4 shadow relative">
    <h1 class="text-3xl font-bold text-center text-green-900">PrairiePin</h1>
    <p class="text-center text-green-700">Because the grid doesn't have street signs.</p>
    <div class="absolute top-4 right-4 space-x-4">
      <a href="/user-profile.html" class="text-sm text-blue-600 underline">Update Profile</a>
      <a href="#" onclick="logout()" class="text-sm text-red-600 underline">Log Out</a>
    </div>
  </header>

  <main class="p-6 max-w-4xl mx-auto">
    <h2 id="greeting" class="text-xl font-semibold text-green-900 mb-4"></h2>

    <div class="mb-6">
      <label for="lld" class="block text-sm font-medium text-gray-700">Enter Legal Land Description (LLD)</label>
      <input type="text" id="lld" name="lld" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="e.g. SW-12-34-1-W4" />
      <button onclick="convertLLD()" class="mt-3 bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded">Convert</button>
    </div>

    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700">Result</label>
      <p id="latitude" class="mt-1 text-gray-800"></p>
      <p id="longitude" class="text-gray-800"></p>
      <a id="map-link" href="#" target="_blank" class="text-blue-600 underline mt-2 block">View on Google Maps</a>
      <button onclick="copyCoordinates()" class="mt-3 bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded">Copy Coordinates</button>
    </div>

    <div id="successBox" class="hidden bg-green-100 text-green-800 p-2 rounded mb-4">Coordinates successfully retrieved!</div>
    <div id="errorBox" class="hidden bg-red-100 text-red-800 p-2 rounded mb-4">An error occurred during conversion.</div>

    <h3 class="text-lg font-semibold text-gray-900 mt-8 mb-2">Last 10 Lookups</h3>
    <table class="min-w-full bg-white rounded shadow">
      <thead class="bg-gray-200">
        <tr>
          <th class="py-2 px-4 text-left text-sm font-medium text-gray-700">Timestamp</th>
          <th class="py-2 px-4 text-left text-sm font-medium text-gray-700">LLD Entered</th>
          <th class="py-2 px-4 text-left text-sm font-medium text-gray-700">Province</th>
          <th class="py-2 px-4 text-left text-sm font-medium text-gray-700">Latitude</th>
          <th class="py-2 px-4 text-left text-sm font-medium text-gray-700">Longitude</th>
        </tr>
      </thead>
      <tbody id="lookup-table-body"></tbody>
    </table>
  </main>

  <script>
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    }

    function decodeJWT(token) {
      try {
        return JSON.parse(atob(token.split('.')[1]));
      } catch {
        return null;
      }
    }

    const token = localStorage.getItem('token');
    const decoded = decodeJWT(token);

    if (!token || !decoded) {
      document.getElementById('errorBox').textContent = '‚ö†Ô∏è Session expired. Redirecting...';
      document.getElementById('errorBox').classList.remove('hidden');
      setTimeout(() => window.location.href = '/login.html', 2000);
    } else {
      if (decoded?.firstName) {
		  document.getElementById('greeting').textContent = `Welcome back, ${decoded.firstName}!`;
		}
      fetchLookups();
    }

    async function convertLLD() {
      const lld = document.getElementById('lld').value;
      try {
        const res = await fetch('https://prairiepin-production.up.railway.app/convert?lld=' + encodeURIComponent(lld), {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await res.json();
        if (res.ok && data.latitude && data.longitude) {
          document.getElementById('latitude').textContent = `Latitude: ${data.latitude}`;
          document.getElementById('longitude').textContent = `Longitude: ${data.longitude}`;
          document.getElementById('map-link').href = `https://www.google.com/maps?q=${data.latitude},${data.longitude}`;
          document.getElementById('successBox').classList.remove('hidden');
          document.getElementById('errorBox').classList.add('hidden');
        } else {
          throw new Error('Invalid result');
        }
      } catch (err) {
        console.error(err);
        document.getElementById('successBox').classList.add('hidden');
        document.getElementById('errorBox').classList.remove('hidden');
      }
    }

    function copyCoordinates() {
      const lat = document.getElementById('latitude').textContent.split(': ')[1];
      const long = document.getElementById('longitude').textContent.split(': ')[1];
      navigator.clipboard.writeText(`${lat}, ${long}`);
    }

    async function fetchLookups() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
          const res = await fetch('https://prairiepin-production.up.railway.app/lookups', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          const data = await res.json();
          console.log("üîç Fetched lookup data:", data); // <--- Check this in browser console
          
          const tbody = document.getElementById('lookup-table-body');
          tbody.innerHTML = '';

          const last10 = data.lookups?.slice(0, 10) || [];

          last10.forEach((lookup, index) => {
            const row = document.createElement('tr');
            row.className = index % 2 === 0 ? 'bg-white' : 'bg-green-50';

            row.innerHTML = `
              <td class="px-3 py-2">${new Date(lookup.timestamp).toLocaleString()}</td>
              <td class="px-3 py-2">${lookup.lld_entered}</td>
              <td class="px-3 py-2">${lookup.province || '‚Äî'}</td>
              <td class="px-3 py-2">${lookup.latitude}</td>
              <td class="px-3 py-2">${lookup.longitude}</td>
            `;

            tbody.appendChild(row);
          });
        } catch (err) {
          console.error("‚ùå Error fetching lookups:", err);
        }
      }
  </script>
</body>
</html>
