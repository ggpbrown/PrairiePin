<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PrairiePin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Header -->
  <header class="bg-[#F1FDF4] p-4 shadow-md relative flex items-center justify-between">
    <h1 class="text-2xl font-bold text-green-900">PrairiePin</h1>
    <div class="space-x-4">
      <a href="/user-profile.html" class="text-sm text-blue-600 underline">My Profile</a>
      <a href="#" onclick="logout()" class="text-sm text-blue-600 underline">Logout</a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-4xl mx-auto mt-8 bg-white p-6 rounded-xl shadow-md">
    <h2 id="greeting" class="text-xl font-semibold text-green-900 mb-4 text-center"></h2>

    <div class="mb-6">
      <label for="lld" class="block text-sm font-medium text-gray-700">Enter Legal Land Description (LLD)</label>
      <input type="text" id="lld" name="lld" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="e.g. SW-24-38-20-W5" />
      <button onclick="convertLLD()" class="mt-3 bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded">Convert</button>
    </div>

    <div id="result-box" class="mb-6 hidden">
      <p class="text-green-700 font-medium">✅ Coordinates successfully retrieved!</p>
      <p><strong>Latitude:</strong> <span id="latitude"></span></p>
      <p><strong>Longitude:</strong> <span id="longitude"></span></p>
      <p><a id="mapLink" href="#" target="_blank" class="text-blue-600 underline">View on Google Maps</a></p>
      <button onclick="copyCoordinates()" class="mt-2 bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded">Copy Coordinates</button>
    </div>

    <div id="error" class="text-red-600 font-medium hidden mb-4"></div>

    <h3 class="text-lg font-semibold mt-8 mb-2">Last 10 Lookups</h3>
    <table class="w-full border border-gray-300">
      <thead class="bg-[#F1FDF4]">
        <tr>
          <th class="text-left px-3 py-2 border-b">Timestamp</th>
          <th class="text-left px-3 py-2 border-b">LLD</th>
          <th class="text-left px-3 py-2 border-b">Province</th>
          <th class="text-left px-3 py-2 border-b">Latitude</th>
          <th class="text-left px-3 py-2 border-b">Longitude</th>
        </tr>
      </thead>
      <tbody id="lookup-table-body"></tbody>
    </table>
  </main>

  <script>
    function decodeJWT(token) {
      try {
        return JSON.parse(atob(token.split('.')[1]));
      } catch {
        return null;
      }
    }

    const token = localStorage.getItem('token');
    const decoded = decodeJWT(token);

    if (!token || !decoded) {
      window.location.href = '/login.html';
    } else {
      if (decoded.firstName) {
        document.getElementById('greeting').textContent = `Welcome back, ${decoded.firstName}!`;
      }
      fetchLookups();
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    }

    async function convertLLD() {
      const lld = document.getElementById('lld').value.trim();
      const resultBox = document.getElementById('result-box');
      const errorBox = document.getElementById('error');

      resultBox.classList.add('hidden');
      errorBox.classList.add('hidden');

      try {
        const res = await fetch('https://prairiepin-production.up.railway.app/convert?lld=' + encodeURIComponent(lld), {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await res.json();
        if (res.ok) {
          document.getElementById('latitude').textContent = data.latitude;
          document.getElementById('longitude').textContent = data.longitude;
          document.getElementById('mapLink').href = `https://www.google.com/maps?q=${data.latitude},${data.longitude}`;
          resultBox.classList.remove('hidden');
          fetchLookups();
        } else {
          errorBox.textContent = data.error || 'Something went wrong';
          errorBox.classList.remove('hidden');
        }
      } catch (err) {
        errorBox.textContent = '⚠️ Session expired. Redirecting...';
        errorBox.classList.remove('hidden');
        setTimeout(() => {
          window.location.href = '/login.html';
        }, 2000);
      }
    }

    function copyCoordinates() {
      const lat = document.getElementById('latitude').textContent;
      const lon = document.getElementById('longitude').textContent;
      const text = `${lat}, ${lon}`;
      navigator.clipboard.writeText(text);
    }

    function fetchLookups() {
      fetch('https://prairiepin-production.up.railway.app/lookups', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById('lookup-table-body');
        tbody.innerHTML = '';
        const last10 = data.slice(0, 10);
        last10.forEach((lookup, index) => {
          const row = document.createElement('tr');
          row.className = index % 2 === 0 ? 'bg-white' : 'bg-[#F1FDF4]';
          row.innerHTML = `
            <td class="px-3 py-2">${new Date(lookup.timestamp).toLocaleString()}</td>
            <td class="px-3 py-2">${lookup.lld_entered}</td>
            <td class="px-3 py-2">${lookup.province || '—'}</td>
            <td class="px-3 py-2">${lookup.latitude}</td>
            <td class="px-3 py-2">${lookup.longitude}</td>
          `;
          tbody.appendChild(row);
        });
      });
    }
  </script>
</body>
</html>