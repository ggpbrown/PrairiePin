<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PrairiePin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-100 font-sans">
  <div class="bg-green-50 p-4 shadow relative">
    <div class="absolute top-4 right-6 flex space-x-4 text-sm">
      <a href="/user-profile.html" class="text-blue-600 underline">Update Profile</a>
      <a id="admin-link" href="/admin.html" class="text-blue-600 underline hidden">Admin Tools</a>
      <a href="#" onclick="logout()" class="text-red-600 underline">Log Out</a>
    </div>
    <h1 class="text-3xl font-bold text-green-900 text-center">PrairiePin</h1>
    <p class="text-green-700 text-center text-sm">Because the grid doesn't have street signs.</p>
  </div>

  <main class="p-6 max-w-4xl mx-auto">
    <h2 id="greeting" class="text-lg font-semibold text-green-900 mb-4"></h2>

    <div class="mb-6">
      <label for="lld" class="block text-sm font-medium text-gray-700">Enter Legal Land Description (LLD)</label>
      <input type="text" id="lld" name="lld" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="e.g. SW-24-38-20-W5" />
      <button onclick="convertLLD()" class="mt-3 bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded">Convert</button>
    </div>

    <div class="mb-6">
	  <label for="coordsOutput" class="block text-sm font-medium text-gray-700">Result</label>
	  <textarea id="coordsOutput" class="mt-1 block w-full border border-gray-300 rounded-md p-2" rows="3" readonly></textarea>
	  <button onclick="copyCoordinates()" class="mt-3 bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded">Copy Coordinates</button>
	</div>
	<!-- Hidden success box -->
	<div id="result" class="hidden mt-4 p-4 bg-green-100 text-green-900 rounded">
	  Coordinates successfully retrieved!
	</div>
	
	<!-- Hidden error box -->
	<div id="error" class="hidden mt-4 p-4 bg-red-100 text-red-900 rounded"></div>
  </main>

  <script>
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    }

    async function convertLLD() {
	  const lld = document.getElementById('lld').value.trim();
	  const token = localStorage.getItem('token');
	
	  if (!token) {
	    window.location.href = '/login.html';
	    return;
	  }
	
	  const resultBox = document.getElementById('result');
	  const errorBox = document.getElementById('error');
	
	  resultBox.classList.add('hidden');
	  errorBox.classList.add('hidden');
	
	  try {
	    const res = await fetch(`https://prairiepin-production.up.railway.app/convert?lld=${encodeURIComponent(lld)}`, {
	      headers: {
	        'Authorization': `Bearer ${token}`
	      }
	    });
	
	    const data = await res.json();
	    if (res.ok) {
	      document.getElementById('coordsOutput').value = `${data.latitude}, ${data.longitude}`;
	      resultBox.classList.remove('hidden');
	
	      fetchLookups();  // Refresh dashboard stats
	    } else {
	      errorBox.textContent = data.error || 'Something went wrong';
	      errorBox.classList.remove('hidden');
	    }
	  } catch (err) {
	    errorBox.textContent = '⚠️ Session expired. Redirecting...';
	    setTimeout(() => {
	      window.location.href = '/login.html';
	    }, 2000);
	    errorBox.classList.remove('hidden');
	  }
	}
    function copyCoordinates() {
      const text = document.getElementById('result').value;
      if (text) {
        navigator.clipboard.writeText(text).then(() => {
          alert('Coordinates copied to clipboard!');
        });
      }
    }

    function decodeJWT(token) {
      try {
        return JSON.parse(atob(token.split('.')[1]));
      } catch {
        return null;
      }
    }

    const token = localStorage.getItem('token');
    const decoded = decodeJWT(token);

    if (decoded) {
      const greeting = document.getElementById('greeting');
      greeting.textContent = `Welcome back, ${decoded.firstName}!`;
    }

    if (decoded?.isAdmin) {
      document.getElementById('admin-link').classList.remove('hidden');
    }
  </script>
</body>
</html>