<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PrairiePin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script>
    // Redirect to login if no token is present
    if (!localStorage.getItem('token')) {
      window.location.href = '/login.html';
    }
  </script>
</head>
<body class="bg-gray-50 min-h-screen p-6 text-gray-800">
  <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold mb-4 text-center">PrairiePin</h1>
    <p class="text-sm text-center mb-6">Because the grid doesn't have street signs.</p>

    <label class="block mb-2 font-semibold" for="lld">Enter Legal Land Description (e.g., NW-4-65-19-W4)</label>
    <input id="lld" type="text" class="w-full px-4 py-2 border rounded mb-4" placeholder="SW-12-34-1-W4">

    <button onclick="convertLLD()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Convert</button>
	<button onclick="trySample()" class="w-full bg-gray-200 text-gray-800 py-2 rounded mt-2 hover:bg-gray-300">Try a Sample</button>

    <div id="result" class="mt-4 hidden">
      <p><strong>Latitude:</strong> <span id="latitude"></span></p>
      <p><strong>Longitude:</strong> <span id="longitude"></span></p>
      <button onclick="copyToClipboard()" class="mt-2 text-sm text-blue-600 underline">Copy to Clipboard</button>
    </div>

    <p id="error" class="text-red-500 mt-4 hidden"></p>
  </div>

  <script>
    async function convertLLD() {
      const lld = document.getElementById('lld').value.trim();
      const token = localStorage.getItem('token');
      const resultBox = document.getElementById('result');
      const errorBox = document.getElementById('error');

      resultBox.classList.add('hidden');
      errorBox.classList.add('hidden');

      try {
        const res = await fetch(`https://prairiepin-production.up.railway.app/convert?lld=${encodeURIComponent(lld)}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await res.json();
        if (res.ok) {
          document.getElementById('latitude').textContent = data.latitude;
          document.getElementById('longitude').textContent = data.longitude;
          resultBox.classList.remove('hidden');
        } else {
          errorBox.textContent = data.error || 'Something went wrong';
          errorBox.classList.remove('hidden');
        }
      } catch (err) {
        errorBox.textContent = 'Failed to contact server';
        errorBox.classList.remove('hidden');
      }
    }

    function copyToClipboard() {
      const lat = document.getElementById('latitude').textContent;
      const lng = document.getElementById('longitude').textContent;
      const text = `${lat}, ${lng}`;
      navigator.clipboard.writeText(text);
    }
    
    function trySample() {
		document.getElementById('lld').value = 'NW-4-65-19-W4';
		convertLLD();
}

  </script>
  
  <p id="lookup-count">Loading lookup count...</p>

	<h2>Recent Lookups</h2>
					<table id="lookup-table" border="1" cellpadding="6">
						<thead>
							<tr>
								<th>LLD</th>
								<th>Latitude</th>
								<th>Longitude</th>
								<th>Time</th>
							</tr>
						</thead>
					  <tbody id="lookup-rows">
		    <!-- Data goes here -->
		  </tbody>
		</table>

  <script>
  async function fetchLookups() {
    const token = localStorage.getItem('token');

    try {
      const response = await fetch('https://prairiepin-production.up.railway.app/lookups', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      const data = await response.json();

      if (Array.isArray(data)) {
        const count = data.length;
        document.getElementById('lookup-count').textContent = `You’ve done ${count} lookup(s).`;

        const tbody = document.getElementById('lookup-rows');
        tbody.innerHTML = '';

        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="border px-2 py-1">${row.lld_entered}</td>
            <td class="border px-2 py-1">${row.latitude}</td>
            <td class="border px-2 py-1">${row.longitude}</td>
            <td class="border px-2 py-1">${new Date(row.timestamp).toLocaleString()}</td>
          `;
          tbody.appendChild(tr);
        });

      } else {
        document.getElementById('lookup-count').textContent = 'Unable to load lookup data.';
      }
    } catch (err) {
      console.error(err);
      document.getElementById('lookup-count').textContent = '⚠️ Failed to fetch lookup data';
    }
  }

  fetchLookups();
</script>


		
</body>
</html>
