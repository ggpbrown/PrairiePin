<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PrairiePin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#085e46',
            accent: '#8cc084',
            softgreen: '#F1FDF4',
            softgray: '#F5F6F8',
            steel: '#91a2a8'
          }
        }
      }
    }
  </script>
</head>
<body class="bg-softgray min-h-screen">
  <header class="bg-softgreen p-4 shadow flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-primary">PrairiePin</h1>
      <p class="text-sm text-steel">Because the grid doesn't have street signs.</p>
    </div>
    <div class="flex gap-4">
      <a href="/user-profile.html" class="text-sm text-blue-600 underline">My Profile</a>
      <a href="#" onclick="logout()" class="bg-red-600 text-white px-4 py-1 rounded hover:bg-red-700 text-sm">Logout</a>
    </div>
  </header>

  <main class="max-w-4xl mx-auto mt-8 bg-white p-6 rounded-xl shadow-md">
    <h2 id="greeting" class="text-xl font-semibold text-center text-primary mb-6"></h2>
    <div class="mb-6">
      <label for="lld" class="block text-sm font-medium text-gray-700">Enter Legal Land Description (LLD)</label>
      <input type="text" id="lld" name="lld" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="e.g. SW-24-38-20-W5" />
      <button onclick="convertLLD()" class="mt-3 bg-primary hover:bg-green-800 text-white px-4 py-2 rounded">Convert</button>
    </div>
    <div id="resultBox" class="mb-6 hidden">
      <label for="result" class="block text-sm font-medium text-gray-700">Result</label>
      <textarea id="result" class="mt-1 block w-full border border-gray-300 rounded-md p-2" rows="3" readonly></textarea>
      <a id="mapLink" href="#" target="_blank" class="text-blue-600 underline block mt-2">View on Google Maps</a>
      <button onclick="copyCoordinates()" class="mt-3 bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded">Copy Coordinates</button>
    </div>
    <div id="errorBox" class="text-red-600 hidden"></div>

    <h3 class="text-lg font-semibold text-primary mt-10 mb-4">Last 10 Lookups</h3>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="bg-softgreen">
            <th class="px-3 py-2 text-left">Date/Time</th>
            <th class="px-3 py-2 text-left">LLD</th>
            <th class="px-3 py-2 text-left">Province</th>
            <th class="px-3 py-2 text-left">Latitude</th>
            <th class="px-3 py-2 text-left">Longitude</th>
          </tr>
        </thead>
        <tbody id="lookup-table-body"></tbody>
      </table>
    </div>
  </main>

  <script>
    function decodeJWT(token) {
      try {
        return JSON.parse(atob(token.split('.')[1]));
      } catch {
        return null;
      }
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    }

    async function convertLLD() {
      const lld = document.getElementById('lld').value;
      const token = localStorage.getItem('token');

      document.getElementById('resultBox').classList.add('hidden');
      document.getElementById('errorBox').classList.add('hidden');

      try {
        const res = await fetch('https://prairiepin-production.up.railway.app/convert', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ lld })
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.error || 'Unknown error');

        const text = `Latitude: ${data.latitude}\nLongitude: ${data.longitude}`;
        document.getElementById('result').value = text;
        document.getElementById('mapLink').href = `https://www.google.com/maps?q=${data.latitude},${data.longitude}`;
        document.getElementById('resultBox').classList.remove('hidden');
      } catch (err) {
        document.getElementById('errorBox').textContent = err.message;
        document.getElementById('errorBox').classList.remove('hidden');
      }
    }

    function copyCoordinates() {
      const coords = document.getElementById('result').value;
      navigator.clipboard.writeText(coords);
    }

    async function fetchLookups() {
      const token = localStorage.getItem('token');
      if (!token) return;

      const res = await fetch('https://prairiepin-production.up.railway.app/lookups', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      const last10 = data.slice(0, 10);

      const tbody = document.getElementById('lookup-table-body');
      tbody.innerHTML = '';
      last10.forEach((lookup, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-white' : 'bg-softgreen';
        row.innerHTML = `
          <td class="px-3 py-2">${new Date(lookup.timestamp).toLocaleString()}</td>
          <td class="px-3 py-2">${lookup.lld_entered}</td>
          <td class="px-3 py-2">${lookup.province || 'â€”'}</td>
          <td class="px-3 py-2">${lookup.latitude}</td>
          <td class="px-3 py-2">${lookup.longitude}</td>
        `;
        tbody.appendChild(row);
      });
  } catch (err) {
    console.error('Error fetching lookups:', err);
  }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      const decoded = decodeJWT(token);

      if (decoded?.firstName) {
        document.getElementById('greeting').textContent = `Welcome back, ${decoded.firstName}!`;
      }

      if (decoded?.isAdmin) {
        const link = document.createElement('a');
        link.href = '/admin.html';
        link.textContent = 'Admin Tools';
        link.className = 'text-sm text-blue-600 underline';
        document.querySelector('header .flex').prepend(link);
      }

      fetchLookups();
    });
  </script>
</body>
</html>