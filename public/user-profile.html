<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Profile | PrairiePin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          prairie: '#F1FDF4',
          brandgreen: '#085e46',
          lime: '#8cc084',
          greygreen: '#91a2a8',
          lightgreen: '#c1d7ae',
        }
      }
    }
  }
</script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <header class="bg-highlight p-4 shadow relative">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-primary">PrairiePin</h1>
        <p class="text-sm text-secondary -mt-1">Because the grid doesn't have street signs.</p>
      </div>
      <div class="text-sm space-x-4">
        <a href="/dashboard.html" class="text-blue-600 hover:underline">Back to Dashboard</a>
        <a href="#" onclick="logout()" class="text-red-600 hover:underline">Logout</a>
      </div>
    </div>
  </header>
  <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-md relative">
    

    <h1 class="text-2xl font-bold mb-4 text-center">My Profile</h1>

    <form id="profile-form" class="space-y-4">
      <div>
        <label for="first_name" class="block text-sm font-medium">First Name</label>
        <input type="text" id="first_name" class="w-full mt-1 border p-2 rounded" />
      </div>

      <div>
        <label for="last_name" class="block text-sm font-medium">Last Name</label>
        <input type="text" id="last_name" class="w-full mt-1 border p-2 rounded" />
      </div>

      <div>
        <label for="email" class="block text-sm font-medium">Email</label>
        <input type="email" id="email" class="w-full mt-1 border p-2 rounded" disabled />
      </div>

      <div class="border-t pt-4">
        <h2 class="font-semibold text-sm mb-2">Change Password</h2>
        <input type="password" id="new_password" class="w-full mb-2 border p-2 rounded" placeholder="New password" />
        <input type="password" id="confirm_password" class="w-full mb-4 border p-2 rounded" placeholder="Confirm new password" />
      </div>

      <div id="error" class="text-red-600 hidden"></div>
      <div id="success" class="text-green-600 hidden"></div>

      <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
        Save Changes
      </button>
    </form>
  </div>

  <script>
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    }

    const token = localStorage.getItem('token');
    const headers = { 'Authorization': `Bearer ${token}` };

    async function loadProfile() {
      const res = await fetch('https://prairiepin-production.up.railway.app/me', { headers });
      const data = await res.json();
      document.getElementById('first_name').value = data.first_name;
      document.getElementById('last_name').value = data.last_name;
      document.getElementById('email').value = data.email;
    }

    document.getElementById('profile-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const first_name = document.getElementById('first_name').value.trim();
      const last_name = document.getElementById('last_name').value.trim();
      const new_password = document.getElementById('new_password').value.trim();
      const confirm_password = document.getElementById('confirm_password').value.trim();

      const body = { first_name, last_name };
      if (new_password && new_password === confirm_password) {
        body.password = new_password;
      } else if (new_password || confirm_password) {
        showError("Passwords must match.");
        return;
      }

      try {
        const res = await fetch('https://prairiepin-production.up.railway.app/me', {
          method: 'PUT',
          headers: { ...headers, 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error('Update failed');
        showSuccess("Profile updated!");
      } catch (err) {
        showError("Error updating profile.");
      }
    });

    function showError(msg) {
      const el = document.getElementById('error');
      el.textContent = msg;
      el.classList.remove('hidden');
      document.getElementById('success').classList.add('hidden');
    }

    function showSuccess(msg) {
      const el = document.getElementById('success');
      el.textContent = msg;
      el.classList.remove('hidden');
      document.getElementById('error').classList.add('hidden');
    }

    loadProfile();
  </script>
</body>
</html>